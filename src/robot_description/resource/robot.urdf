<?xml version="1.0"?>
<robot name="simple_robot">

    <!-- Base Link: 로봇의 본체 (중심 링크)
         모든 다른 링크들이 연결되는 기준점 -->
    <link name="base_link">
        <!-- Visual: Gazebo에서 보이는 시각적 표현 -->
        <visual>
            <origin xyz="0 0 0.05" rpy="0 0 0"/>  <!-- xyz: 위치(m), rpy: 회전(rad), z=0.05로 바퀴 위에 배치 -->
            <geometry>
                <box size="0.6 0.4 0.2"/>  <!-- 직육면체: 길이 0.6m, 너비 0.4m, 높이 0.2m (센서 추가 공간 고려) -->
            </geometry>
            <material name="blue">
                <color rgba="0 0 0.8 1"/>  <!-- RGBA: Red, Green, Blue, Alpha (0~1) -->
            </material>
        </visual>
        <!-- Collision: 물리 엔진이 충돌을 계산할 때 사용하는 형상 (보통 visual과 동일) -->
        <collision>
            <origin xyz="0 0 0.05" rpy="0 0 0"/>
            <geometry>
                <box size="0.6 0.4 0.2"/>
            </geometry>
        </collision>
        <!-- Inertial: 물리 시뮬레이션에 필요한 질량과 관성 정보 -->
        <inertial>
            <origin xyz="0 0 0.05" rpy="0 0 0"/>
            <mass value="10"/>  <!-- 질량 10kg -->
            <inertia ixx="0.2" ixy="0" ixz="0" iyy="0.3" iyz="0" izz="0.4"/>  <!-- 관성 모멘트 텐서 -->
        </inertial>
    </link>

    <!-- Left Wheel: 왼쪽 구동 바퀴 (모터로 제어됨) -->
    <link name="left_wheel">
        <visual>
            <geometry>
                <cylinder radius="0.1" length="0.08"/>  <!-- 원통: 반지름 0.1m(지름 20cm), 두께 0.08m -->
            </geometry>
            <material name="black">
                <color rgba="0 0 0 1"/>  <!-- 검은색 -->
            </material>
        </visual>
        <collision>
            <geometry>
                <cylinder radius="0.1" length="0.08"/>
            </geometry>
        </collision>
        <inertial>
            <mass value="1"/>  <!-- 바퀴 질량 1kg -->
            <inertia ixx="0.005" ixy="0" ixz="0" iyy="0.005" iyz="0" izz="0.01"/>  <!-- 원통의 관성 모멘트 -->
        </inertial>
    </link>

    <!-- Joint: 본체와 바퀴를 연결하는 관절 -->
    <joint name="left_wheel_joint" type="continuous">  <!-- continuous: 360도 무한 회전 가능 -->
        <parent link="base_link"/>  <!-- 부모 링크: 본체 -->
        <child link="left_wheel"/>  <!-- 자식 링크: 바퀴 -->
        <origin xyz="0.15 0.24 0" rpy="1.5708 0 0"/>  <!-- 위치: 앞쪽 0.15m, 왼쪽 0.24m, 회전: 90도(바퀴를 세움) -->
        <axis xyz="0 0 -1"/>  <!-- 회전축: -z축 방향 (바퀴 회전 방향 반전) -->
    </joint>

    <!-- Right Wheel: 오른쪽 구동 바퀴 (모터로 제어됨) -->
    <link name="right_wheel">
        <visual>
            <geometry>
                <cylinder radius="0.1" length="0.08"/>
            </geometry>
            <material name="black">
                <color rgba="0 0 0 1"/>
            </material>
        </visual>
        <collision>
            <geometry>
                <cylinder radius="0.1" length="0.08"/>
            </geometry>
        </collision>
        <inertial>
            <mass value="1"/>
            <inertia ixx="0.005" ixy="0" ixz="0" iyy="0.005" iyz="0" izz="0.01"/>
        </inertial>
    </link>

    <joint name="right_wheel_joint" type="continuous">
        <parent link="base_link"/>
        <child link="right_wheel"/>
        <origin xyz="0.15 -0.24 0" rpy="1.5708 0 0"/>  <!-- 위치: 앞쪽 0.15m, 오른쪽 -0.24m (y축 음수 방향) -->
        <axis xyz="0 0 -1"/>  <!-- 회전축: -z축 방향 (바퀴 회전 방향 반전) -->
    </joint>

    <!-- Rear Caster: 뒤쪽 캐스터 볼 (자유롭게 구르는 보조 바퀴) -->
    <link name="rear_caster">
        <visual>
            <geometry>
                <sphere radius="0.05"/>  <!-- 구: 반지름 0.05m -->
            </geometry>
            <material name="gray">
                <color rgba="0.5 0.5 0.5 1"/>  <!-- 회색 -->
            </material>
        </visual>
        <collision>
            <geometry>
                <sphere radius="0.05"/>
            </geometry>
        </collision>
        <inertial>
            <mass value="0.5"/>  <!-- 캐스터 질량 0.5kg -->
            <inertia ixx="0.001" ixy="0" ixz="0" iyy="0.001" iyz="0" izz="0.001"/>  <!-- 구의 관성 모멘트 -->
        </inertial>
    </link>

    <joint name="rear_caster_joint" type="fixed">  <!-- fixed: 고정 조인트 (회전하지 않음) -->
        <parent link="base_link"/>
        <child link="rear_caster"/>
        <origin xyz="-0.2 0 -0.05" rpy="0 0 0"/>  <!-- 위치: 뒤쪽 -0.2m, 중앙, 아래 -0.05m -->
    </joint>

    <!-- Gazebo에서 캐스터 볼이 자유롭게 미끄러지도록 마찰 설정 -->
    <gazebo reference="rear_caster">
        <mu1>0.0</mu1>  <!-- 마찰 계수 0 (완전히 미끄러움) -->
        <mu2>0.0</mu2>
    </gazebo>

    <!-- Gazebo Differential Drive Plugin
         두 개의 바퀴를 독립적으로 제어하여 전진/후진/회전 구현
         양쪽 바퀴 속도가 같으면 직진, 다르면 회전 -->
    <gazebo>
        <plugin filename="gz-sim-diff-drive-system" name="gz::sim::systems::DiffDrive">
            <left_joint>left_wheel_joint</left_joint>
            <right_joint>right_wheel_joint</right_joint>
            <wheel_separation>0.48</wheel_separation>
            <wheel_radius>0.1</wheel_radius>
            <odom_publish_frequency>50</odom_publish_frequency>
            <topic>cmd_vel</topic>
            <tf_topic>/tf</tf_topic>
            <frame_id>odom</frame_id>
            <child_frame_id>base_link</child_frame_id>
        </plugin>
    </gazebo>

    <!-- Gazebo Sensors System Plugin: 센서 시스템 활성화 -->
    <gazebo>
        <plugin filename="gz-sim-sensors-system" name="gz::sim::systems::Sensors">
            <render_engine>ogre2</render_engine>  <!-- 렌더링 엔진 지정 -->
        </plugin>
    </gazebo>

    <!-- LiDAR Sensor Link: 센서의 물리적 형태 정의 -->
    <link name="lidar_link">
        <!-- Visual: 센서의 시각적 모양 (빨간 원통) -->
        <visual>
            <geometry>
                <cylinder radius="0.05" length="0.07"/>
            </geometry>
            <material name="red">
                <color rgba="1 0 0 1"/>
            </material>
        </visual>
        <!-- Collision: 충돌 감지용 형상 -->
        <collision>
            <geometry>
                <cylinder radius="0.05" length="0.07"/>
            </geometry>
        </collision>
        <!-- Inertial: 질량 및 관성 정보 -->
        <inertial>
            <mass value="0.3"/>
            <inertia ixx="0.001" ixy="0" ixz="0" iyy="0.001" iyz="0" izz="0.001"/>
        </inertial>
    </link>

    <!-- LiDAR Joint: 센서를 본체에 고정 연결 -->
    <joint name="lidar_joint" type="fixed">
        <parent link="base_link"/>  <!-- 부모: 로봇 본체 -->
        <child link="lidar_link"/>   <!-- 자식: LiDAR 센서 -->
        <origin xyz="0.2 0 0.2" rpy="0 0 0"/>  <!-- 위치: 앞쪽 0.2m, 위쪽 0.2m -->
    </joint>

    <!-- Gazebo LiDAR Plugin: 실제 센서 기능 구현 -->
    <gazebo reference="lidar_link">  <!-- lidar_link에 센서 플러그인 적용 -->
        <sensor name="gpu_lidar" type="gpu_lidar">  <!-- 센서 이름 및 타입 정의 -->
            <topic>scan</topic>  <!-- 센서 데이터를 발행할 Gazebo 토픽 이름 -->
            <update_rate>10</update_rate>  <!-- 센서 업데이트 빈도 (Hz) -->
            <lidar>  <!-- LiDAR 센서 설정 -->
                <scan>  <!-- 스캔 패턴 설정 -->
                    <horizontal>  <!-- 수평 스캔 설정 -->
                        <samples>360</samples>  <!-- 한 회전당 측정점 개수 -->
                        <resolution>1</resolution>  <!-- 각 측정점 간 해상도 -->
                        <min_angle>-3.14159</min_angle>  <!-- 스캔 시작 각도 (라디안) -->
                        <max_angle>3.14159</max_angle>   <!-- 스캔 종료 각도 (라디안 -->
                    </horizontal>
                </scan>
                <range>  <!-- 거리 측정 범위 -->
                    <min>0.12</min>  <!-- 최소 감지 거리 (미터) -->
                    <max>10.0</max>  <!-- 최대 감지 거리 (미터) -->
                </range>
            </lidar>
            <visualize>true</visualize>  <!-- Gazebo에서 시각적 표시 여부 -->
        </sensor>
    </gazebo>

    <gazebo>
        <plugin filename="gz-sim-joint-state-publisher-system"
                name="gz::sim::systems::JointStatePublisher">
            <topic>/world/empty/joint_state</topic>
        </plugin>
    </gazebo>

    <!-- Joint State Publisher Plugin -->
    <gazebo>
        <plugin filename="gz-sim-joint-state-publisher-system" name="gz::sim::systems::JointStatePublisher">
        </plugin>
    </gazebo>

</robot>